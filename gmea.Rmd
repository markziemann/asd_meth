---
title: "ASD Gene Methylation Enrichment Analysis"
author: "Mark Ziemann"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: yes
    toc_float: true
    code_folding: hide
    fig_width: 7
    fig_height: 7
theme: cosmo
---

##  Introduction

Previously, Mandhri and I analysed the B-PROOF 450K data, trying to understand
whether vitamin supplementation caused changes in gene methylation.
We used Limma and some basic analyses, which showed no specific probes with FDR<0.05,
nor any DMRs.

In this analysis we will use the principle of Gene Set Enrichment Analysis, applying it
to many probes belonging to genes.
If the probes are trending in concert, then we can make some judgement about the
enrichment of those probes.
The statistical test used is the 1 sided t-test, which can be applied to competitive
or self contained test types.

```{r,libs}

library("parallel")
library("dplyr")
library("kableExtra")
library("eulerr")
library("mitch")
library("IlluminaHumanMethylationEPICanno.ilm10b2.hg19")
library("tictoc")

```

## Get array annotation data

```{r,anno}

ann <- getAnnotation(IlluminaHumanMethylationEPICanno.ilm10b2.hg19)
myann <- data.frame(ann[,c("UCSC_RefGene_Name","Regulatory_Feature_Group")])

```

# Load ASD data

Previously Namitha performed this analysis - there weren't many significant genes
so I thought it would be a good idea to use GMEA.

## Read in and inspect the data

```{r,read1}

dm <- read.csv("ASD_blood_top_dmps_onADOS_withintw_Nov27_limma.csv")

head(dm,50) %>%
  kbl(caption = "Top significant genes with limma") %>%
  kable_paper("hover", full_width = F)

rownames(dm) <- dm$Name
dm <- dm[,c("UCSC_RefGene_Name","t")]

# histogram of t values
hist(dm$t,breaks=seq(from=-7,to=6,by=1))

```

## Whole gene analysis

```{r,wg}

calc_sc <- function(dm,CORES=detectCores()/2) {
  gn <- unique(unlist(strsplit( dm$UCSC_RefGene_Name ,";")))
  gnl <- strsplit( dm$UCSC_RefGene_Name ,";")
  gnl <- mclapply(gnl,unique,mc.cores=CORES)
  dm$UCSC_RefGene_Name <- gnl
  l <- mclapply(1:nrow(dm), function(i) {
    a <- dm[i,]
    len <- length(a[[1]][[1]])
    tvals <- as.numeric(rep(a[2],len))
    genes <- a[[1]][[1]]
    data.frame(genes,tvals)
  },mc.cores=CORES)
  df <- do.call(rbind,l)
  gme_res <- mclapply( 1:length(gn), function(i) {
    g <- gn[i]
    tstats <- df[which(df$genes==g),"tvals"]
    myn <- length(tstats)
    mymean <- mean(tstats)
    mymedian <- median(tstats)
    if ( length(tstats) < 2 ) {
    pval=1
    } else {
    wtselfcont <- t.test(tstats)
    pval=wtselfcont$p.value
    }
    res <- c("gene"=g,"nprobes"=myn,"mean"=mymean,"median"=mymedian,
      "p-value(sc)"=pval)
  } , mc.cores=CORES )
  gme_res_df <- do.call(rbind, gme_res)
  rownames(gme_res_df) <- gme_res_df[,1]
  gme_res_df <- gme_res_df[,-1]
  tmp <- apply(gme_res_df,2,as.numeric)
  rownames(tmp) <- rownames(gme_res_df)
  gme_res_df <- as.data.frame(tmp)
  gme_res_df$sig <- -log10(gme_res_df[,4])
  gme_res_df <- gme_res_df[order(-gme_res_df$sig),]
  gme_res_df$`fdr(sc)` <- p.adjust(gme_res_df$`p-value(sc)`)
  out <- list("df"=df,"gme_res_df"=gme_res_df)
  return(out)
}

tic()
gme_res_wholegene <- calc_sc(dm)
time2 <- toc() #4core: 239.0 247.0
time2
df <- gme_res_wholegene[[1]]
res <- gme_res_wholegene[[2]]
write.table(res,file="gmea_wholegene.tsv")

```

## Table of top results.

```{r, toptable}

head(res,50) %>%
  kbl(caption = "Top significant genes with GMEA") %>%
  kable_paper("hover", full_width = F)

```

## Volcano plots

```{r,volcano1}

# volcano selfcont
sig <- subset(res,`fdr(sc)` < 0.05)
plot(res$median , -log10(res$`p-value(sc)`) ,
  xlab="effect size (mean t-stat)", ylab="-log10(p-value)",
  pch=19, cex=0.5, col="gray",main="self contained test")
grid()
points(sig$median , -log10(sig$`p-value(sc)`) ,
  pch=19, cex=0.5, col="red")

# nprobes plot
plot(res$nprobes,res$sig,log="x",ylim=c(0,50),pch=19,cex=0.6)
points(sig$nprobes,sig$sig,col="red",pch=19,cex=0.62)
MIN = min(sig$nprobes)
LEFT = nrow(subset(res,nprobes<MIN))
RIGHT = nrow(subset(res,nprobes>MIN))
SIG = nrow(sig)
TOT = nrow(res)
HEADER <- paste(TOT, "genes in total.", SIG, "with FDR<0.05.",
  RIGHT, "well covered and", LEFT, "poorly covered")
mtext(HEADER)
abline(v=MIN,lty=2)

```

## Boxplots

Boxplots smallest pvalue.

```{r,box1}

par(mfrow=c(1,2))
n=50
# self contained

gs <- head(rownames(res),50)
tstats <- lapply(gs, function(g) {
  df[which(df$genes==g),"tvals"]
})
names(tstats) <- gs

tstats <- tstats[order(unlist(lapply(tstats,median)))]
boxplot(tstats,horizontal=TRUE,las=1,
  main="smallest p-val(selfcont)",cex.axis=0.6,
  xlab="t-statistic")
grid()

n=50
# effect size median
sig <- subset(res,`fdr(sc)` < 0.05)
gs <- head(rownames(sig[order(-abs(sig$median)),]),n)

if ( length(gs) >2 ) {
  tstats <- lapply(gs, function(g) {
    df[which(df$genes==g),"tvals"]
  })
  names(tstats) <- gs
  tstats <- tstats[order(unlist(lapply(tstats,median)))]
  boxplot(tstats,horizontal=TRUE,las=1,
    main="biggest effect size(median)",cex.axis=0.6,
    xlab="t-statistic")
  grid()
} else {
  plot(1)
  mtext("too few significant genes found")
}
par(mfrow=c(1,1))

```

## Mitch

```{r,dm1_mitch}

dmscore <- data.frame( res$median * res$sig)
rownames(dmscore) <- rownames(res)
colnames(dmscore) <- "metric"
hist(dmscore$metric)

if ( ! file.exists("ReactomePathways.gmt") ) {
  download.file("https://reactome.org/download/current/ReactomePathways.gmt.zip",
    destfile="ReactomePathways.gmt.zip")
  unzip("ReactomePathways.gmt.zip")
}
file.info("ReactomePathways.gmt")
genesets <- gmt_import("ReactomePathways.gmt")
length(genesets)

mres <- mitch_calc(x=dmscore, genesets=genesets, priority="effect")

head(mres$enrichment_result,20) %>%
  kbl(caption = "Top enriched gene sets with GMEA-Mitch") %>%
  kable_paper("hover", full_width = F)

mitch_report(mres,outfile="mitch_gmea_wg.html",overwrite=TRUE)
```

## 1-sided T gene set test

Consider using 1-sided t-test if mitch is biased.

```{r,t_enrichment_test1}

m1 <- dmscore
gse_res <- mclapply( 1:length(genesets), function(i) {
  gs <- genesets[i]
  name <- names(gs)
  n_members <- length(which(rownames(m1) %in% gs[[1]]))
  if ( n_members > 4 ) {
    tstats <- m1[which(rownames(m1) %in% gs[[1]]),]
    myn <- length(tstats)
    mymean <- mean(tstats)
    mymedian <- median(tstats)
    wt <- t.test(tstats)
    res <- c(name,myn,mymean,mymedian,wt$p.value)
  }
} , mc.cores = CORES)

gse_res_df <- do.call(rbind, gse_res)
rownames(gse_res_df) <- gse_res_df[,1]
gse_res_df <- gse_res_df[,-1]
colnames(gse_res_df) <- c("n_genes","t_mean","t_median","p.value")
tmp <- apply(gse_res_df,2,as.numeric)
rownames(tmp) <- rownames(gse_res_df)
gse_res_df <- tmp
gse_res_df <- as.data.frame(gse_res_df)
gse_res_df <- gse_res_df[order(gse_res_df$p.value),]
gse_res_df$logp <- -log10(gse_res_df$p.value )
gse_res_df$fdr <- p.adjust(gse_res_df$p.value,method="fdr")

head(gse_res_df)

head(gse_res_df[order(-abs(gse_res_df$t_median)),],10)

head(gse_res_df,30) %>%
  kbl(caption = "Top significant genesets") %>%
  kable_paper("hover", full_width = F)

head(gse_res_df[order(-abs(gse_res_df$t_median)),],30) %>%
  kbl(caption = "Top effect size genesets") %>%
  kable_paper("hover", full_width = F)

sig <- subset(gse_res_df,fdr<0.05)
nsig <- nrow(sig)

# volcano
plot(gse_res_df$t_median , gse_res_df$logp ,
  xlab="effect size (mean t-stat)", ylab="-log10(p-value)",
  pch=19, cex=0.5, col="gray")

points(sig$t_median , sig$logp ,
  pch=19, cex=0.5, col="red")

abline(h=5,lty=2)

# boxplot most significant
n=50
sig2 <- head(gse_res_df,n)
sig2 <- sig2[order(-sig2$t_median),]
gs <- rownames(sig2)[1:n]
tstats <- lapply(1:n, function(i) {
  g <- rownames(sig2)[i]
  genes <- genesets[[which(names(genesets) == g)]]
  m1[which(rownames(m1) %in% genes),"metric"]
} )
names(tstats) <- gs

# boxplot
par(mar=c(5,20,3,1))
boxplot(tstats,horizontal=TRUE,las=1,
  main="most significant gene sets",cex.axis=0.6,
  xlab="mean t-statistic")
grid()

# boxplot biggest effect size
n=50
sig2 <- tail(sig[order(abs(sig$t_median)),],n)
gs <- rownames(sig2)[1:n]
tstats <- lapply(1:n, function(i) {
  g <- rownames(sig2)[i]
  genes <- genesets[[which(names(genesets) == g)]]
  m1[which(rownames(m1) %in% genes),"metric"]
} )
names(tstats) <- gs

# boxplot
boxplot(tstats,horizontal=TRUE,las=1,
  main="largest effect size",cex.axis=0.6,
  xlab="mean t-statistic")
grid()

par(mfrow=c(1,1))

```

## Promoter analysis only

```{r,promo}

dm <- read.csv("ASD_blood_top_dmps_onADOS_withintw_Nov27_limma.csv")
rownames(dm) <- dm$Name
dm <- dm[,9:ncol(dm)]

dm <- merge(dm,myann,by=0)
rownames(dm) <- dm[,1]
dm[,1] = NULL
dm <- dm[grep("Promo",dm$Regulatory_Feature_Group),]
dim(dm)
dm <- dm[order(dm$P.Value),]

head(dm,50) %>%
  kbl(caption = "Top significant genes with limma") %>%
  kable_paper("hover", full_width = F)

dm <- dm[,c("UCSC_RefGene_Name","t")]

# histogram of t values
hist(dm$t,breaks=seq(from=-7,to=6,by=1))

```

```{r,promo2}

# set cores to used for parallel execution

tic()
gme_res_promoter <- calc_sc(dm)
time2 <- toc() #4core 30.3 
time2

df <- gme_res_promoter[[1]]
res <- gme_res_promoter[[2]] 
write.table(res ,file="gmea_promo.tsv")

```

## Table of top results.

```{r, toptable_promoter}

head(res,50) %>%
  kbl(caption = "Top significant genes with GMEA") %>%
  kable_paper("hover", full_width = F)

```

## Volcano plots

```{r,volcano1_promoter}

# volcano selfcont
sig <- subset(res,`fdr(sc)` < 0.05)
plot(res$median , -log10(res$`p-value(sc)`) ,
  xlab="effect size (mean t-stat)", ylab="-log10(p-value)",
  pch=19, cex=0.5, col="gray",main="self contained test")
grid()
points(sig$median , -log10(sig$`p-value(sc)`) ,
  pch=19, cex=0.5, col="red")

```

## Boxplots

Boxplots smallest pvalue.

```{r,box1_promoter}

par(mfrow=c(1,2))
n=50
# self contained

gs <- head(rownames(res),50)
tstats <- lapply(gs, function(g) {
  df[which(df$genes==g),"tvals"]
})
names(tstats) <- gs

tstats <- tstats[order(unlist(lapply(tstats,median)))]
boxplot(tstats,horizontal=TRUE,las=1,
  main="smallest p-val(selfcont)",cex.axis=0.6,
  xlab="t-statistic")
grid()

n=50
# effect size median
sig <- subset(res,`fdr(sc)` < 0.05)
gs <- head(rownames(sig[order(-abs(sig$median)),]),n)

if ( length(gs) >2 ) {
  tstats <- lapply(gs, function(g) {
    df[which(df$genes==g),"tvals"]
  })
  names(tstats) <- gs
  tstats <- tstats[order(unlist(lapply(tstats,median)))]
  boxplot(tstats,horizontal=TRUE,las=1,
    main="biggest effect size(median)",cex.axis=0.6,
    xlab="t-statistic")
  grid()
} else {
  plot(1)
  mtext("too few significant genes found")
}
par(mfrow=c(1,1))

```

## Mitch

```{r,dm1_mitch_promo}

dmscore <- data.frame( res$median * res$sig)

rownames(dmscore) <- rownames(res)

colnames(dmscore) <- "metric"

genesets <- gmt_import("ReactomePathways.gmt")

mres <- mitch_calc(x=dmscore, genesets=genesets,priority="effect")

head(mres$enrichment_result,20) %>%
  kbl(caption = "Top enriched gene sets with GMEA-Mitch (promoter only)") %>%
  kable_paper("hover", full_width = F)

mitch_report(mres,outfile="gmea_mitch_promo.html",overwrite=TRUE)

```

## 1-sided t gene set test

Consider using 1-sided t-test if mitch is biased.

```{r,t_enrichment_test_2}

m1 <- res[,"median",drop=FALSE]
gse_res <- mclapply( 1:length(genesets), function(i) {
  gs <- genesets[i]
  name <- names(gs)
  n_members <- length(which(rownames(m1) %in% gs[[1]]))
  if ( n_members > 4 ) {
    tstats <- m1[which(rownames(m1) %in% gs[[1]]),]
    myn <- length(tstats)
    mymean <- mean(tstats)
    mymedian <- median(tstats)
    wt <- t.test(tstats)
    res <- c(name,myn,mymean,mymedian,wt$p.value)
  }
} , mc.cores = CORES)

gse_res_df <- do.call(rbind, gse_res)
rownames(gse_res_df) <- gse_res_df[,1]
gse_res_df <- gse_res_df[,-1]
colnames(gse_res_df) <- c("n_genes","t_mean","t_median","p.value")
tmp <- apply(gse_res_df,2,as.numeric)
rownames(tmp) <- rownames(gse_res_df)
gse_res_df <- tmp
gse_res_df <- as.data.frame(gse_res_df)
gse_res_df <- gse_res_df[order(gse_res_df$p.value),]
gse_res_df$logp <- -log10(gse_res_df$p.value )
gse_res_df$fdr <- p.adjust(gse_res_df$p.value,method="fdr")

head(gse_res_df)


```

## Session Information

For reproducibility.

```{r,sessioninfo}

sessionInfo()

```
